<!DOCTYPE html>



  


<html class="theme-next mist use-motion" lang="zh-Hans">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>
<meta name="theme-color" content="#222">









<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />




  
  
  
  

  
    
    
  

  

  

  

  

  
    
    
    <link href="//fonts.googleapis.com/css?family=Lato:300,300italic,400,400italic,700,700italic&subset=latin,latin-ext" rel="stylesheet" type="text/css">
  






<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.2" rel="stylesheet" type="text/css" />


  <meta name="keywords" content="android," />








  <link rel="shortcut icon" type="image/x-icon" href="/favicon.ico?v=5.1.2" />






<meta name="description" content="Android的动画可以分为三种:View动画、帧动画和属性动画。帧动画通过顺序播放一系列图像从而产生动画效果，如果图片过大就会导致OOM；View动画通过对场景里的对象不断做图像变换(平移、缩放、旋转、透明度)从而产生动画效果，它是一种渐进式动画，并且View动画支持自定义；属性动画通过动态地改变对象的属性从而达到动画效果，属性动画为API11的新特性。">
<meta name="keywords" content="android">
<meta property="og:type" content="article">
<meta property="og:title" content="Android动画深入分析">
<meta property="og:url" content="https://lianqiangjava.github.io/2018/05/11/android-animation/index.html">
<meta property="og:site_name" content="GoodLogic">
<meta property="og:description" content="Android的动画可以分为三种:View动画、帧动画和属性动画。帧动画通过顺序播放一系列图像从而产生动画效果，如果图片过大就会导致OOM；View动画通过对场景里的对象不断做图像变换(平移、缩放、旋转、透明度)从而产生动画效果，它是一种渐进式动画，并且View动画支持自定义；属性动画通过动态地改变对象的属性从而达到动画效果，属性动画为API11的新特性。">
<meta property="og:locale" content="zh-Hans">
<meta property="og:updated_time" content="2018-09-13T22:35:57.428Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Android动画深入分析">
<meta name="twitter:description" content="Android的动画可以分为三种:View动画、帧动画和属性动画。帧动画通过顺序播放一系列图像从而产生动画效果，如果图片过大就会导致OOM；View动画通过对场景里的对象不断做图像变换(平移、缩放、旋转、透明度)从而产生动画效果，它是一种渐进式动画，并且View动画支持自定义；属性动画通过动态地改变对象的属性从而达到动画效果，属性动画为API11的新特性。">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Mist',
    sidebar: {"position":"left","display":"post","offset":12,"offset_float":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: true,
    duoshuo: {
      userId: '0',
      author: '博主'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="https://lianqiangjava.github.io/2018/05/11/android-animation/"/>





  <title>Android动画深入分析 | GoodLogic</title>
  





  <script type="text/javascript">
    var _hmt = _hmt || [];
    (function() {
      var hm = document.createElement("script");
      hm.src = "https://hm.baidu.com/hm.js?a25508733e80088d0f3d73536030c2b5";
      var s = document.getElementsByTagName("script")[0];
      s.parentNode.insertBefore(hm, s);
    })();
  </script>










</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  
  
    
  

  <div class="container sidebar-position-left page-post-detail ">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">GoodLogic</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle"></p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br />
            
            分类
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            归档
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />
            
            标签
          </a>
        </li>
      
        
        <li class="menu-item menu-item-about">
          <a href="/about/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-user"></i> <br />
            
            关于
          </a>
        </li>
      

      
    </ul>
  

  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://lianqiangjava.github.io/2018/05/11/android-animation/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="曲连强">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="GoodLogic">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">Android动画深入分析</h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-05-11T10:15:14+08:00">
                2018-05-11
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/android/" itemprop="url" rel="index">
                    <span itemprop="name">android</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          
             <span id="/2018/05/11/android-animation/" class="leancloud_visitors" data-flag-title="Android动画深入分析">
               <span class="post-meta-divider">|</span>
               <span class="post-meta-item-icon">
                 <i class="fa fa-eye"></i>
               </span>
               
                 <span class="post-meta-item-text">阅读次数 </span>
               
                 <span class="leancloud-visitors-count"></span>
             </span>
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        <p>Android的动画可以分为三种:View动画、帧动画和属性动画。帧动画通过顺序播放一系列图像从而产生动画效果，如果图片过大就会导致OOM；View动画通过对场景里的对象不断做图像变换(平移、缩放、旋转、透明度)从而产生动画效果，它是一种渐进式动画，并且View动画支持自定义；属性动画通过动态地改变对象的属性从而达到动画效果，属性动画为API11的新特性。</p>
<a id="more"></a>
<h2 id="一、-View动画"><a href="#一、-View动画" class="headerlink" title="一、 View动画"></a>一、 View动画</h2><p>View动画的作用对象是View,它支持4种动画效果，分别为平移、缩放、旋转、透明度动画。</p>
<h4 id="1-1-View动画的种类"><a href="#1-1-View动画的种类" class="headerlink" title="1.1 View动画的种类"></a>1.1 View动画的种类</h4><p>View动画的四种变换效果对应着Animation的四个类: TranslateAnimation、ScaleAnimation、RotateAnimation和AlphaAnimation,如下表，这四种动画既可以通过XML来定义，也可以通过代码来动态创建，对于View动画，建议采用XML来定义动画，这样可读性更好。</p>
<table>
<thead>
<tr>
<th style="text-align:center">名 称</th>
<th style="text-align:center">标 签</th>
<th style="text-align:center">子 类</th>
<th style="text-align:center">效 果</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">平移动画</td>
<td style="text-align:center">&lt;translate&gt;</td>
<td style="text-align:center">TranslateAnimation</td>
<td style="text-align:center">移动View</td>
</tr>
<tr>
<td style="text-align:center">缩放动画</td>
<td style="text-align:center">&lt;scale&gt;</td>
<td style="text-align:center">ScaleAnimation</td>
<td style="text-align:center">放大或缩小View</td>
</tr>
<tr>
<td style="text-align:center">旋转动画</td>
<td style="text-align:center">&lt;rotate&gt;</td>
<td style="text-align:center">RotateAnimation</td>
<td style="text-align:center">旋转View</td>
</tr>
<tr>
<td style="text-align:center">透明度动画</td>
<td style="text-align:center">&lt;alpha&gt;</td>
<td style="text-align:center">AlphaAnimation</td>
<td style="text-align:center">改变View的透明度</td>
</tr>
</tbody>
</table>
<p>要使用View动画，首先要创建动画的XML文件，这个文件的路径为:res/anim/filename.xml。View动画的描述文件是有固定的语法的，如下所示:</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">&lt;?xml version="1.0" encoding="utf-8"?&gt;</span><br><span class="line"><span class="tag">&lt;<span class="name">set</span> <span class="attr">xmlns:android</span>=<span class="string">"http://schemas.android.com/apk/res/android"</span></span></span><br><span class="line"><span class="tag">    <span class="attr">android:interpolator</span>=<span class="string">"@[package:]anim/interpolator_resource"</span></span></span><br><span class="line"><span class="tag">    <span class="attr">android:shareInterpolator</span>=<span class="string">[</span>"<span class="attr">true</span>" | "<span class="attr">false</span>"] &gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">alpha</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:fromAlpha</span>=<span class="string">"float"</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:toAlpha</span>=<span class="string">"float"</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">scale</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:fromXScale</span>=<span class="string">"float"</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:toXScale</span>=<span class="string">"float"</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:fromYScale</span>=<span class="string">"float"</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:toYScale</span>=<span class="string">"float"</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:pivotX</span>=<span class="string">"float"</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:pivotY</span>=<span class="string">"float"</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">translate</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:fromXDelta</span>=<span class="string">"float"</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:toXDelta</span>=<span class="string">"float"</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:fromYDelta</span>=<span class="string">"float"</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:toYDelta</span>=<span class="string">"float"</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">rotate</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:fromDegrees</span>=<span class="string">"float"</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:toDegrees</span>=<span class="string">"float"</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:privotX</span>=<span class="string">"float"</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:privotY</span>=<span class="string">"float"</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">set</span>&gt;</span></span><br><span class="line">        ...</span><br><span class="line">    <span class="tag">&lt;/<span class="name">set</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">set</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>从上面语法可以看出，View动画既可以是单个动画，也可以由一系列动画组成。</p>
<p>&lt;set&gt;标签表示动画集合，对应AnimationSet类，它可以包含若干个动画，并且它的内部也是<br>可以嵌套其它动画集合的，它的两个属性的含义如下:</p>
<blockquote>
<p><strong><em>android:interpolator</em></strong></p>
</blockquote>
<p>表示动画集合所采用的插值器，插值器影响动画的速度，比如非匀速动画就需要<br>通过插值器来控制动画的播放过程。这个属性可以不指定，默认为@android:anim/<br>accelerate_decelerate_interpolator,即加速减速插值器。</p>
<blockquote>
<p><strong><em>android:shareInterpolator</em></strong></p>
</blockquote>
<p>表示集合中的动画是否和集合共享同一个插值器。如果集合不指定插值器，那么子动画就需要单独指定所需的插值器或者使用默认值。</p>
<p><strong><em>&lt;translate&gt;</em></strong> 标签表示平移动画，对应TranslateAnimation类，它可以使一个View在水平和竖直方向完成平移的动画效果，它的一系列属性含义如下:</p>
<ul>
<li>android:fromXDelta——表示 x 的起始值，比如 0；</li>
<li>android:toXDelta——表示 x 的结束值，比如 100；</li>
<li>android:fromYDelta——表示 y 的起始值；</li>
<li>android:toYDelta——表示 y 的结束值。</li>
</ul>
<p><strong><em>&lt;scale&gt;</em></strong> 标签表示缩放动画，对应ScaleAnimation,它可以使View具有放大或者缩小的动画效果，它的一系列属性的含义如下:</p>
<ul>
<li>android:fromXScale——水平方向缩放的起始值，比如 0.5；</li>
<li>android:toXScale——水平方向缩放的结束值，比如 1.2；</li>
<li>android:fromYScale——竖直方向缩放的起始值；</li>
<li>android:toYScale——竖直方向缩放的结束值；</li>
<li>android:pivotX——缩放的轴点的 x 坐标，它会影响缩放的效果；</li>
<li><p>android:pivotY——缩放的轴点的 y 坐标，它会影响缩放的效果。</p>
<p>  在&lt;scale&gt;标签中提到的轴点的概念，默认情况下轴点是View的中心点，如果水平方向进行缩放的话会导致View向左右两个方向同时进行缩放，但是如果把轴点设为View的右边界，那么View就只会向左边进行缩放，反之则向右边进行缩放。</p>
</li>
</ul>
<p><strong><em>&lt;rotate&gt;</em></strong> 标签标示旋转动画，对应RotateAnimation类，它的属性含义如下：</p>
<ul>
<li>android:fromDegrees——旋转开始的角度，比如 0；</li>
<li>android:toDegrees——旋转结束的角度，比如 180；</li>
<li>android:pivotX——旋转的轴点的 x 坐标；</li>
<li><p>android:pivotY——旋转的轴点的 y 坐标。</p>
<p>在旋转动画中也有轴点的概念，它也会影响到旋转的具体效果。它扮演着旋转轴的角色，即View是围绕着轴点进行旋转的，默认情况下轴点位View的中心点。</p>
</li>
</ul>
<p><strong><em>&lt;alpha&gt;</em></strong> 标签表示透明度动画，对应AlphaAnimation,它可以改变View的透明度，它的属性含义如下：</p>
<ul>
<li>android:fromAlpha——表示透明度的起始值，比如 0.1；</li>
<li>android:toAlpha——表示透明度的结束值，比如 1。</li>
</ul>
<p>上面介绍了View动画的XML格式，除了上面介绍的属性外，View动画还有一些常用的属性，如下：</p>
<ul>
<li>android:duration——动画的持续时间；</li>
<li>android:fillAfter——动画结束以后View是否停留在结束位置，true表示View停留在结束位置，false则不停留。</li>
</ul>
<p>下面是一个实际例子：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">&lt;?xml version="1.0" encoding="utf-8"?&gt;</span><br><span class="line"><span class="tag">&lt;<span class="name">set</span> <span class="attr">xmlns:android</span>=<span class="string">"http://schemas.android.com/apk/res/android"</span></span></span><br><span class="line"><span class="tag">    <span class="attr">android:fillAfter</span>=<span class="string">"true"</span> &gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">translate</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:duration</span>=<span class="string">"100"</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:fromXDelta</span>=<span class="string">"0"</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:toXDelta</span>=<span class="string">"100"</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:fromYDelta</span>=<span class="string">"0"</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:toYDelta</span>=<span class="string">"100"</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:interpolator</span>=<span class="string">"@android:anim/linear_interpolator"</span>/&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">rotate</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:duration</span>=<span class="string">"400"</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:fromDegrees</span>=<span class="string">"0"</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:toDegrees</span>=<span class="string">"90"</span> /&gt;</span></span><br></pre></td></tr></table></figure>
<p>使用上面的动画：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Button mButton = (Button)findViewById(R.id.button);</span><br><span class="line">Animation animation = AnimationUtils.loadAnimation(<span class="keyword">this</span>,R.anim.animation_test);</span><br><span class="line">mButton.startAnimation(animation);</span><br></pre></td></tr></table></figure>
<p>除了在XML中定义动画外，还可以通过代码来应用动画，如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">AlphaAnimation alphaAnimation = <span class="keyword">new</span> AlphaAnimation(<span class="number">0</span>,<span class="number">1</span>);</span><br><span class="line">alphaAnimation.setDuration(<span class="number">300</span>);</span><br><span class="line">mButton.startAnimation(alphaAnimation);</span><br></pre></td></tr></table></figure>
<p>另外，通过Animation的setAnimationListener方法可以给View动画添加过程监听，接口如下所示：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="class"><span class="keyword">interface</span> <span class="title">AnimationListener</span></span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">onAnimationStart</span><span class="params">(Animation animation)</span></span>;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">onAnimationEnd</span><span class="params">(Animation animation)</span></span>;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">onAnimationRepeat</span><span class="params">(Animation animation)</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="1-2-自定义View动画"><a href="#1-2-自定义View动画" class="headerlink" title="1.2 自定义View动画"></a>1.2 自定义View动画</h4><p>除了系统提供的四种View动画外，我们还可以自定义View动画。只需要继承Animation这个抽象类，然后重写它的initialize和applyTransformation方法，在initialize方法中做一些初始化工作，在applyTransformation中进行相应的矩阵变换即可，很多时候需要采用Camera来简化矩阵变换的过程。下面例子来自Android的ApiDemos中的一个自定义View动画Rotate3dAnimation,代码如下:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Rotate3dAnimation</span> <span class="keyword">extends</span> <span class="title">Animation</span></span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">float</span> mFromDegrees;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">float</span> mToDegrees;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">float</span> mCenterX;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">float</span> mCenterY;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">float</span> mDepthZ;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">boolean</span> mReverse;</span><br><span class="line">    <span class="keyword">private</span> Camera mCamera;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">Rotate3dAnimation</span><span class="params">(<span class="keyword">float</span> fromDegrees,<span class="keyword">float</span> toDegrees,</span></span></span><br><span class="line"><span class="function"><span class="params">        <span class="keyword">float</span> centerX,<span class="keyword">float</span> centerY,<span class="keyword">float</span> depthZ,<span class="keyword">boolean</span> reverse)</span></span>&#123;</span><br><span class="line">        mFromDegrees = fromDegrees;</span><br><span class="line">        mToDegrees = toDegrees;</span><br><span class="line">        mCenterX = centerX;</span><br><span class="line">        mCenterY = centerY;</span><br><span class="line">        mDepthZ = depthZ;</span><br><span class="line">        mReverse = reverse;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">initialize</span><span class="params">(<span class="keyword">int</span> width,<span class="keyword">int</span> height,<span class="keyword">int</span> parentWidth,<span class="keyword">int</span> parentHeight)</span></span>&#123;</span><br><span class="line">        <span class="keyword">super</span>.initialize(width,height,parentWidth,parentHeight);</span><br><span class="line">        mCamera = <span class="keyword">new</span> Camera();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">applyTransformation</span><span class="params">(<span class="keyword">float</span> interpolatedTime,Transformation t)</span></span>&#123;</span><br><span class="line">        <span class="keyword">final</span> <span class="keyword">float</span> fromDegrees = mFromDegress;</span><br><span class="line">        <span class="keyword">float</span> degrees = fromDrees + ((mToDegrees - fromDegrees) * interpolatedTime);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">final</span> <span class="keyword">float</span> centerX = mCenterX;</span><br><span class="line">        <span class="keyword">final</span> <span class="keyword">float</span> centerY = mCenterY;</span><br><span class="line">        <span class="keyword">final</span> Camera camera = mCamera;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">final</span> Matrix matrix = t.getMatrix();</span><br><span class="line"></span><br><span class="line">        camera.save();</span><br><span class="line">        <span class="keyword">if</span>(mReverse)&#123;</span><br><span class="line">            camera.translate(<span class="number">0.0f</span>,<span class="number">0.0f</span>,mDepthZ * interpolatedTime);</span><br><span class="line">        &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">            camera.translate(<span class="number">0.0f</span>,<span class="number">0.0f</span>,mDepthZ * (<span class="number">1.0f</span> - interpolatedTime));</span><br><span class="line">        &#125;</span><br><span class="line">        camera.rotateY(degrees);</span><br><span class="line">        camera.getMatrix(matrix);</span><br><span class="line">        camera.restore();</span><br><span class="line"></span><br><span class="line">        matrix.preTranslate(-centerX,-centerY);</span><br><span class="line">        matrix.postTranslate(centerX,centerY);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="1-3-帧动画"><a href="#1-3-帧动画" class="headerlink" title="1.3 帧动画"></a>1.3 帧动画</h4><p>帧动画是顺序播放一组预先定义好的图片，类似电影播放。不同于View动画，系统提供了另外一个类AnimationDrawable来使用帧动画。帧动画使用比较简单，首先需要通过XML来定义一个AnimationDrawable,如下所示：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">// res/drawable/frame_animation.xml</span><br><span class="line">&lt;?xml version="1.0" encoding="utf-8"?&gt;</span><br><span class="line"><span class="tag">&lt;<span class="name">animation-list</span> <span class="attr">xmlns:android</span>=<span class="string">"http://schemas.android.com/apk/res/android"</span></span></span><br><span class="line"><span class="tag">    <span class="attr">android:oneshot</span>=<span class="string">"false"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">item</span> <span class="attr">android:drawable</span>=<span class="string">"@drawable/image1"</span> <span class="attr">android:duration</span>=<span class="string">"500"</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">item</span> <span class="attr">android:drawable</span>=<span class="string">"@drawable/image2"</span> <span class="attr">android:duration</span>=<span class="string">"500"</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">item</span> <span class="attr">android:drawable</span>=<span class="string">"@drawable/image3"</span> <span class="attr">android:duration</span>=<span class="string">"500"</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">animation-list</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>然后将上述的Drawable作为View的背景并通过Drawable来播放动画即可：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">Button mButton = (Button)findViewById(R.id.button1);</span><br><span class="line">mButton.setBackgroundResource(R.drawable.frame_animation);</span><br><span class="line">AnimationDrawable drawable = (AnimationDrawable)mButton.getBackground();</span><br><span class="line">drawable.start();</span><br></pre></td></tr></table></figure>
<p>帧动画使用比较简单，但是比较容易引起OOM，所以使用帧动画时应尽量避免使用过大尺寸的图片。</p>
<h2 id="二、-View动画的特殊使用场景"><a href="#二、-View动画的特殊使用场景" class="headerlink" title="二、 View动画的特殊使用场景"></a>二、 View动画的特殊使用场景</h2><p>在1.1中介绍了View动画的四种形式，除了这四种形式外，View动画还可以在一些特殊场景下使用，比如在ViewGrop中可以控制子元素的出场效果，在Activity中可以实现不同Activity之间的切换效果。</p>
<h3 id="2-1-LayoutAnimation"><a href="#2-1-LayoutAnimation" class="headerlink" title="2.1 LayoutAnimation"></a>2.1 LayoutAnimation</h3><p>LayoutAnimation作用于ViewGroup,为ViewGroup指定一个动画，这样当它的子元素出场时都会具有这种动画效果。这种效果常常被用在ListView上，我们时常会看到一种特殊的ListView,它的每个item都以一定的动画的形式出现，其实这并非什么高深的技术，它是使用的就是LayoutAnimation。LayoutAnimation也是一个View动画，为了给ViewGroup的子元素加上出场效果，遵循如下步骤。</p>
<p>(1) 定义LayoutAnimation,如下所示</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">// res/anim/anim_layout.xml</span><br><span class="line"><span class="tag">&lt;<span class="name">layoutAnimation</span></span></span><br><span class="line"><span class="tag">    <span class="attr">xmlns:android</span>=<span class="string">"http://schemas.android.com/apk/res/android"</span></span></span><br><span class="line"><span class="tag">    <span class="attr">android:delay</span>=<span class="string">"0.5"</span></span></span><br><span class="line"><span class="tag">    <span class="attr">android:animationOrder</span>=<span class="string">"normal"</span></span></span><br><span class="line"><span class="tag">    <span class="attr">android:animation</span>=<span class="string">"@anim/anim_item"</span>/&gt;</span></span><br></pre></td></tr></table></figure>
<p>它的属性的含义如下</p>
<p><strong><em>android:delay</em></strong></p>
<p>表示子元素开始动画的时间延迟，比如子元素入场动画的时间周期为300ms,那么0.5表示每个子元素都需要延迟150ms才能播放入场动画。总体来说，第一个子元素延迟150ms开始播放入场动画，第二个子元素延迟300ms开始播放动画，依次类推。</p>
<p><strong><em>android:animationOrder</em></strong></p>
<p>表示子元素动画的顺序，有三种选项: normal、reverse 和 random,其中 nomal 表示顺序显示，即排在前面的子元素先开始播放入场动画；reverse 表示逆向显示，即排在后面的子元素先开始播放入场动画；random 则是随机播放入场动画。</p>
<p><strong><em>android:animation</em></strong></p>
<p>为子元素指定具体的入场动画。</p>
<p>(2) 为子元素指定具体的入场动画，如下所示</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">// res/anim/anim_item.xml</span><br><span class="line">&lt;?xml version="1.0" encoding="utf-8"?&gt;</span><br><span class="line"><span class="tag">&lt;<span class="name">set</span> <span class="attr">xmlns:android</span>=<span class="string">"http://schemas.android.com/apk/res/android"</span></span></span><br><span class="line"><span class="tag">    <span class="attr">android:duration</span>=<span class="string">"300"</span></span></span><br><span class="line"><span class="tag">    <span class="attr">android:interpolator</span>=<span class="string">"@android:anim/accelerate_iterpolator"</span></span></span><br><span class="line"><span class="tag">    <span class="attr">android:shareInterpolator</span>=<span class="string">"true"</span> &gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">alpha</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:fromAlpha</span>=<span class="string">"0.0"</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:toAlpha</span>=<span class="string">"1.0"</span>/&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">translate</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:fromXDelta</span>=<span class="string">"500"</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:toXDelta</span>=<span class="string">"0"</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">set</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>(3) 为ViewGroup指定android:layoutAnimation属性: android:layoutAnimation=”@anim/anim_layout”。对于ListView来说，这样ListView的item就具有出场动画了，这种方式适用于所有的ViewGroup，如下所示</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">ListView</span></span></span><br><span class="line"><span class="tag">    <span class="attr">android:id</span>=<span class="string">"@+id/list"</span></span></span><br><span class="line"><span class="tag">    <span class="attr">android:layout_width</span>=<span class="string">"match_parent"</span></span></span><br><span class="line"><span class="tag">    <span class="attr">android:layout_height</span>=<span class="string">"match_parent"</span></span></span><br><span class="line"><span class="tag">    <span class="attr">android:layoutAnimation</span>=<span class="string">"@anim/anim_layout"</span> /&gt;</span></span><br></pre></td></tr></table></figure>
<p>除了在XML中指定LayoutAnimation外，还可以通过LayoutAnimationController来实现，具体代码如下</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">ListView listView = (ListView)layout.findViewById(R.id.list);</span><br><span class="line">Animation animation = AnimationUtils.loadAnimation(<span class="keyword">this</span>,R.anim.anim_item);</span><br><span class="line">LayoutAnimationController controller = <span class="keyword">new</span> LayoutAnimationController(animation);</span><br><span class="line">controller.setDelay(<span class="number">0.5f</span>);</span><br><span class="line">controller.setOrder(LayoutAnimationController.ORDER_NORMAL);</span><br><span class="line">listView.setLayoutAnimation(controller);</span><br></pre></td></tr></table></figure>
<h3 id="2-2-Activity-的切换效果"><a href="#2-2-Activity-的切换效果" class="headerlink" title="2.2 Activity 的切换效果"></a>2.2 Activity 的切换效果</h3><p>Activity 有默认的切换效果，但这个效果我们可以自定义，主要用到overridePendingTransition(int enterAnim,int exitAnim)这个方法，这个方法必须在startActivity(Intent)或者finish()之后被调用才能生效，它的参数含义如下：</p>
<ul>
<li><p>enterAnim——Activity被打开时，所需的动画资源id;</p>
</li>
<li><p>exitAnim——Activity被暂停时，所需的动画资源id。</p>
</li>
</ul>
<p>当启动一个Activity时，可以按照如下方式为其添加自定义的切换效果：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Intent intent = <span class="keyword">new</span> Intent(<span class="keyword">this</span>,TestActivity.class);</span><br><span class="line">startActivity(intent);</span><br><span class="line">overridePendingTransition(R.anim.enter_anim,R.anim.exit_anim);</span><br></pre></td></tr></table></figure>
<p>当Activity退出时，也可以为其指定自己的切换效果，如下</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">finish</span><span class="params">()</span></span>&#123;</span><br><span class="line">    <span class="keyword">super</span>.finish();</span><br><span class="line">    overridePendingTransition(R.anim.enter_anim,R.anim.exit_anim);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>需要注意的是，overridePendingTransition这个方法必须位于startActivity 或者finish的后面，否则动画效果将不起作用。</p>
<p>Fragment也可以添加切换动画，由于Fragment是在API 11中新引入的类，因此为了兼容性我们需要使用support-v4这个兼容包，在这种情况下可以通过FragmentTransation中的setCustomAnimations()方法来添加切换动画，这个切换动画需要是View动画，之所以不能采用属性动画是因为属性动画也是API 11新引入的。</p>
<h2 id="三、-属性动画"><a href="#三、-属性动画" class="headerlink" title="三、 属性动画"></a>三、 属性动画</h2><p>属性动画是API 11 新加入的特性，和 View 动画不同，它对作用对象进行了扩展，属性动画可以对任何对象做动画，甚至还可以没有对象。属性动画中有ViewPropertyAnimator、ObjectAnimator、ValueAnimator 和 AnimatorSet 等概念，通过他们可以实现绚丽的动画。</p>
<h3 id="3-1-使用属性动画"><a href="#3-1-使用属性动画" class="headerlink" title="3.1 使用属性动画"></a>3.1 使用属性动画</h3><p>属性动画可以对任意对象的属性进行动画而不仅仅是View，动画默认的时间间隔300ms,默认帧率 10ms/帧。其可以达到的效果是: 在一个时间间隔内完成对象从一个属性值到另一个属性值的改变。因此，属性动画几乎是无所不能的，只要对象有这个属性，它都能实现动画效果。可以采用开源动画库nineoldandroids来兼容以前的版本。</p>
<p>Nineoldandroids 对属性动画做了兼容，在API 11以前的版本其内部是通过代理View动画来实现的，因此在Android低版本上，它的本质还是View动画。比较常用的几个动画类是:ValueAnimator、ObjectAnimator 和 AnimatorSet，其中ObjectAnimator继承自ValueAnimator,AnimatorSet是动画集合，可以定义一组动画，如何使用属性动画呢？下面举几个简单例子。</p>
<p><strong>(1) 使用ViewPropertyAnimator 改变View属性</strong></p>
<p>使用方式：View.animate() 后跟 translationX() 等方法，动画会自动执行。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">view.animate()<span class="comment">//获取ViewPropertyAnimator对象</span></span><br><span class="line">    <span class="comment">//动画持续时间</span></span><br><span class="line">    .setDuration(<span class="number">5000</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment">//透明度</span></span><br><span class="line">    .alpha(<span class="number">0</span>)</span><br><span class="line">    .alphaBy(<span class="number">0</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment">//旋转</span></span><br><span class="line">    .rotation(<span class="number">360</span>)</span><br><span class="line">    .rotationBy(<span class="number">360</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment">//插值器</span></span><br><span class="line">    .setInterpolator(<span class="keyword">new</span> BounceInterpolator())<span class="comment">//回弹</span></span><br><span class="line">                        </span><br><span class="line">    <span class="comment">//动画延迟</span></span><br><span class="line">    .setStartDelay(<span class="number">1000</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment">//是否开启硬件加速</span></span><br><span class="line">    .withLayer()</span><br><span class="line"></span><br><span class="line">    .start();</span><br></pre></td></tr></table></figure>
<p><strong>(2) 改变一个对象(myObject)的translationY属性，让其沿着Y轴向上平移一段距离:</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ObjectAnimator.ofFloat(myObject,<span class="string">"translationY"</span>,-myObject.getHeight()).start();</span><br></pre></td></tr></table></figure>
<p><strong>(3) 改变一个对象的背景色属性，典型的情形是改变View的背景色，下面动画可以让背景色在3秒内实现从0XFFFF8080到0XFF8080FF的渐变，动画会无限循环而且会有反转的效果。</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">ValueAnimator colorAnim = ObjectAnimator.ofInt(<span class="keyword">this</span>,<span class="string">"backgroundColor"</span>,<span class="number">0xFFFF8080</span>,<span class="number">0xFF8080FF</span>);</span><br><span class="line">colorAnim.setDuration(<span class="number">3000</span>);</span><br><span class="line">colorAnim.setEvaluator(<span class="keyword">new</span> ArgbEvaluator());</span><br><span class="line">colorAnim.setRepeatCount(ValueAnimator.INFINITE);</span><br><span class="line">colorAnim.setRepeatMode(ValueAnimator.REVERSE);</span><br><span class="line">colorAnim.start();</span><br></pre></td></tr></table></figure>
<p><strong>(4) 动画集合，5秒内对View 的旋转、平移、缩放和透明度都进行了改变</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">AnimatorSet set = <span class="keyword">new</span> AnimatorSet();</span><br><span class="line">set.playTogether(</span><br><span class="line">    ObjectAnimator.ofFloat(myView,<span class="string">"rotationX"</span>,<span class="number">0</span>,<span class="number">360</span>),</span><br><span class="line">    ObjectAnimator.ofFloat(myView,<span class="string">"translationX"</span>,<span class="number">0</span>,<span class="number">90</span>),</span><br><span class="line">    ObjectAnimator.ofFloat(myView,<span class="string">"scaleX"</span>,<span class="number">1</span>,<span class="number">1.5f</span>),</span><br><span class="line">    ObjectAnimator.ofFloat(myView,<span class="string">"alpha"</span>,<span class="number">1</span>,<span class="number">0.25f</span>,<span class="number">1</span>)</span><br><span class="line">    );</span><br><span class="line">set.setDuration(<span class="number">5</span> * <span class="number">1000</span>).start();</span><br></pre></td></tr></table></figure>
<p><strong>(5) PropertyValuesHolder 同一个动画中改变多个属性</strong></p>
<p>很多时候，你在同一个动画中会需要改变多个属性，例如在改变透明度的同时改变尺寸。如果使用ViewPropertyAnimator，你可以直接用连写的方式来在一个动画中同时改变多个属性：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">view.animate()  </span><br><span class="line">        .scaleX(<span class="number">1</span>)</span><br><span class="line">        .scaleY(<span class="number">1</span>)</span><br><span class="line">        .alpha(<span class="number">1</span>);</span><br></pre></td></tr></table></figure>
<p>而对于 ObjectAnimator，是不能这么用的。不过你可以使用 PropertyValuesHolder 来同时在一个动画中改变多个属性。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">PropertyValuesHolder holder1 = PropertyValuesHolder.ofFloat(<span class="string">"scaleX"</span>, <span class="number">1</span>);  </span><br><span class="line">PropertyValuesHolder holder2 = PropertyValuesHolder.ofFloat(<span class="string">"scaleY"</span>, <span class="number">1</span>);  </span><br><span class="line">PropertyValuesHolder holder3 = PropertyValuesHolder.ofFloat(<span class="string">"alpha"</span>, <span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">ObjectAnimator animator = ObjectAnimator.ofPropertyValuesHolder(view, holder1, holder2, holder3)  </span><br><span class="line">animator.start();</span><br></pre></td></tr></table></figure>
<p>PropertyValuesHolder 的意思从名字可以看出来，它是一个属性值的批量存放地。所以你如果有多个属性需要修改，可以把它们放在不同的 PropertyValuesHolder 中，然后使用 ofPropertyValuesHolder() 统一放进 Animator。这样你就不用为每个属性单独创建一个 Animator 分别执行了。</p>
<p><strong>(6) PropertyValuesHolders.ofKeyframe() 把同一个属性拆分</strong></p>
<p>除了合并多个属性和调配多个动画，你还可以在 PropertyValuesHolder 的基础上更进一步，通过设置  Keyframe（关键帧），把同一个动画属性拆分成多个阶段。例如，你可以让一个进度增加到 100% 后再「反弹」回来。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 在 0% 处开始</span></span><br><span class="line">Keyframe keyframe1 = Keyframe.ofFloat(<span class="number">0</span>, <span class="number">0</span>);  </span><br><span class="line"><span class="comment">// 时间经过 50% 的时候，动画完成度 100%</span></span><br><span class="line">Keyframe keyframe2 = Keyframe.ofFloat(<span class="number">0.5f</span>, <span class="number">100</span>);  </span><br><span class="line"><span class="comment">// 时间见过 100% 的时候，动画完成度倒退到 80%，即反弹 20%</span></span><br><span class="line">Keyframe keyframe3 = Keyframe.ofFloat(<span class="number">1</span>, <span class="number">80</span>);  </span><br><span class="line">PropertyValuesHolder holder = PropertyValuesHolder.ofKeyframe(<span class="string">"progress"</span>, keyframe1, keyframe2, keyframe3);</span><br><span class="line"></span><br><span class="line">ObjectAnimator animator = ObjectAnimator.ofPropertyValuesHolder(view, holder);  </span><br><span class="line">animator.start();</span><br></pre></td></tr></table></figure>
<p>属性动画除了通过代码实现以外，还可以通过XML来定义。属性动画需要定义在res/animator/目录下，它的语法如下所示。</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">set</span> </span></span><br><span class="line"><span class="tag">    <span class="attr">android:ordering</span>=<span class="string">[</span>"<span class="attr">together</span>" | "<span class="attr">sequentially</span>"]&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">objectAnimator</span></span></span><br><span class="line"><span class="tag">        <span class="attr">anddroid:propertyName</span>=<span class="string">"string"</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:duration</span>=<span class="string">"int"</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:valueFrom</span>=<span class="string">"float | int | color"</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:valueTo</span>=<span class="string">"float | int | color"</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:startOffset</span>=<span class="string">"int"</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:repeatCount</span>=<span class="string">"int"</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:repeatMode</span>=<span class="string">[</span>"<span class="attr">restart</span>" | "<span class="attr">reverse</span>"]</span></span><br><span class="line"><span class="tag">        <span class="attr">android:valueType</span>=<span class="string">[</span>"<span class="attr">intType</span>" | "<span class="attr">floatType</span>"]/&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">animator</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:duration</span>=<span class="string">"int"</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:valueFrom</span>=<span class="string">"float | int | color"</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:valueTo</span>=<span class="string">"float | int | color"</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:startOffset</span>=<span class="string">"int"</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:repeatCount</span>=<span class="string">"int"</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:repeatMode</span>=<span class="string">[</span>"<span class="attr">restart</span>" | "<span class="attr">reverse</span>"]</span></span><br><span class="line"><span class="tag">        <span class="attr">android:valueType</span>=<span class="string">[</span>"<span class="attr">intType</span>" | "<span class="attr">floatType</span>"]/&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">set</span>&gt;</span></span><br><span class="line">        ...</span><br><span class="line">    <span class="tag">&lt;/<span class="name">set</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">set</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>属性动画的各种参数都比较好理解，在XML中可以定义ValueAnimator 、ObjectAnimator以及AnimatorSet,其中&lt;set&gt;标签对应AnimatorSet,&lt;animator&gt;标签对应ValueAnimator,而&lt;objectAnimator&gt;则对应ObjectAnimator。&lt;set&gt;标签的android:ordering属性有两个可选值:”together”和”sequentially”,其中”together”表示动画集合中的子动画同时播放，”sequentially”则表示动画集合中的子动画按照前后顺序依次播放，android:ordering属性的默认值是”together”。</p>
<p>对于&lt;objectAnimator&gt;标签的各个属性的含义，下面简单说明一下：</p>
<ul>
<li><p><strong><em>android:propertyName</em></strong>——表示属性动画的作用对象的属性的名称；</p>
</li>
<li><p><strong><em>android:duration</em></strong>——表示动画的时长；</p>
</li>
<li><p><strong><em>android:valueFrom</em></strong>——表示属性的起始值；</p>
</li>
<li><p><strong><em>android:valueTo</em></strong>——表示属性的结束值</p>
</li>
<li><p><strong><em>android:startOffset</em></strong>——表示动画的延迟时间，当动画开始后，需要延迟多少毫秒才会真正播放此动画；</p>
</li>
<li><p><strong><em>android:repeatCount</em></strong>——表示动画的重复次数；</p>
</li>
<li><p><strong><em>android:repeatMode</em></strong>——表示动画的重复模式；</p>
</li>
<li><p><strong><em>android:valueType</em></strong>——表示android:propertyName所指定的属性的类型，有”intType”和”floatType”两个可选项，分别表示属性的类型为整型和浮点型。另外，如果android:propertyName所指定的属性表示的是颜色，那么不需要指定android:valueType，系统会自动对颜色类型的属性做处理。</p>
</li>
</ul>
<p>对于一个动画来说，有两个属性需要特殊说明一下，一个是android:repeatCount,它表示动画循环的次数，默认值为0，其中-1表示无限循环；另一个是android:repeatMode,它表示动画循环的模式，有两个选项：”restart” 和 “reverse”,分别表示连续重复和逆向重复。连续重复就是动画每次都重新开始播放，而逆向重复是指第一次播放完后，第二次会倒着播放动画，第三次再重头开始播放，第四次再倒着播放，如此反复。</p>
<p>下面是一个具体的例子，通过XML定义一个属性动画并将其作用在View上，如下所示：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">// res/animator/property_animator.xml</span><br><span class="line"><span class="tag">&lt;<span class="name">set</span> <span class="attr">android:ordering</span>=<span class="string">"together"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">objectAnimator</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:propertyName</span>=<span class="string">"x"</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:duration</span>=<span class="string">"300"</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:valueTo</span>=<span class="string">"200"</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:valueType</span>=<span class="string">"intType"</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">objectAnimator</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:propertyName</span>=<span class="string">"y"</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:duration</span>=<span class="string">"300"</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:valueTo</span>=<span class="string">"300"</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:valueType</span>=<span class="string">"intType"</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">set</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>下面介绍如何使用，如下所示</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">AnimatorSet set = (AnimatorSet)AnimatorInflater.loadAnimator(myContext,R.anim.property_animator);</span><br><span class="line">set.setTarget(mButton);</span><br><span class="line">set.start();</span><br></pre></td></tr></table></figure>
<p>在实际开发中建议采用代码来实现属性动画，这是因为通过代码来实现比较简单，更重要的是，很多时候一个属性的起始值是无法提前确定的。另外，<br>ViewPropertyAnimator、ObjectAnimator、ValueAnimator 这三种 Animator，<br>它们其实是一种递进的关系：从左到右依次变得更加难用，也更加灵活。</p>
<p>它们的性能是一样的，因为 ViewPropertyAnimator 和 ObjectAnimator 的内部实现其实都是 ValueAnimator，ObjectAnimator 更是本来就是 ValueAnimator 的子类，它们三个的性能并没有差别。</p>
<p>它们的差别只是使用的便捷性以及功能的灵活性。<br>所以在实际使用时候的选择，只要遵循一个原则就行：尽量用简单的。<br>能用 View.animate() 实现就不用 ObjectAnimator，<br>能用 ObjectAnimator 就不用 ValueAnimator。</p>
<h3 id="3-2-理解插值器和估值器"><a href="#3-2-理解插值器和估值器" class="headerlink" title="3.2 理解插值器和估值器"></a>3.2 理解插值器和估值器</h3><p>TimeInterpolator 时间插值器，它的作用是根据时间流逝的百分比来计算出当前属性值改变的百分比，系统预置的有LinearInterpolator(线性插值器: 匀速动画)、AccelerateDecelerateInterpolator(加速减速插值器:动画两头慢中间快)和DecelerateInterpolator(减速插值器:动画越来越慢)等。TypeEvaluator 为类型估值算法，也叫估值器，它的作用是根据当前属性改变的百分比来计算改变后的属性值，系统预置的有IntEvaluator(针对整型属性)、FloatEvaluator(针对浮点型属性)和ArgbEvaluator(针对Color属性)。属性动画中的插值器(Interpolator)和估值器(TypeEvaluator)很重要，它们是实现非匀速动画的重要手段。</p>
<p>如下表所示，它表示一个匀速动画，采用了线性插值器和整型估值器算法，在40ms内，View的x属性实现从0到40的变换。</p>
<table>
<thead>
<tr>
<th style="text-align:center">x = 0</th>
<th style="text-align:center">x = 10</th>
<th style="text-align:center">x = 20</th>
<th style="text-align:center">x = 30</th>
<th style="text-align:center">x = 40</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">t = 0ms</td>
<td style="text-align:center">t = 10ms</td>
<td style="text-align:center">t = 20ms</td>
<td style="text-align:center">t = 30ms</td>
<td style="text-align:center">t = 40ms</td>
</tr>
</tbody>
</table>
<pre><code>duration = 40ms
</code></pre><p>由于动画的默认刷新率为10ms/帧，所以该动画将分5帧进行，我们来考虑第三帧(x=20,t=20ms)，当时间t=20ms的时候，时间流逝的百分比是0.5(20/40=0.5)，意味着现在时间过了一半，那x应该改变多少呢？这个就由插值器和估值器算法来确认。对于线性插值器来说，当时间流逝一半的时候，x的变换也应该是一半，即x的改变为0.5，下面是它的源码:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">LinearInterpolator</span> <span class="keyword">implements</span> <span class="title">Interpolator</span></span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">LinearInterpolator</span><span class="params">()</span></span>&#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">LinearInterpolator</span><span class="params">(Context context, AttributeSet attrs)</span></span>&#123;&#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">float</span> <span class="title">getIntterpolation</span><span class="params">(<span class="keyword">float</span> input)</span></span>&#123;</span><br><span class="line">        <span class="keyword">return</span> input;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>很显然，线性插值器的返回值和输入值一样，因此插值器返回的值是0.5，这意味着x的改变是0.5，这个时候插值器的工作就完成了。具体x变成了什么值，这个需要估值算法来确定，下面是整型估值算法源码：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">IntEvaluator</span> <span class="keyword">implements</span> <span class="title">TypeEvaluator</span>&lt;<span class="title">Integer</span>&gt;</span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> Integer <span class="title">evaluate</span><span class="params">(<span class="keyword">float</span> fraction,Integer startValue,Integer endValue)</span></span>&#123;</span><br><span class="line">        <span class="keyword">int</span> startInt = startValue;</span><br><span class="line">        <span class="keyword">return</span> (<span class="keyword">int</span>)(startInt + fraction * (endValue - startInt));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>上述算法很简单，evaluate的三个参数分别表示估值小数、开始值和结束值，对应于本例分别是0.5,0,40。根据上述算法，整型估值返回给我们的结果是20，这就是(x=20,t=20ms)的由来。</p>
<p>属性动画要求对象的该属性有set方法和get方法（可选）。插值器和估值算法除了系统提供的外，我们还可以自定义。自定义插值器需要实现Interpolator或TimerInterpolator接口，自定义估值算法需要实现TypeEvaluator。</p>
<p><strong>自定义 TypeEvaluator</strong></p>
<p>借助于 TypeEvaluator，属性动画就可以通过 ofObject() 来对不限定类型的属性做动画了。方式很简单：</p>
<ul>
<li><p>为目标属性写一个自定义的 TypeEvaluator</p>
</li>
<li><p>使用 ofObject() 来创建 Animator，并把自定义的 TypeEvaluator 作为参数填入</p>
</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="class"><span class="keyword">class</span> <span class="title">PointFEvaluator</span> <span class="keyword">implements</span> <span class="title">TypeEvaluator</span>&lt;<span class="title">PointF</span>&gt; </span>&#123;  </span><br><span class="line">   PointF newPoint = <span class="keyword">new</span> PointF();</span><br><span class="line"></span><br><span class="line">   <span class="meta">@Override</span></span><br><span class="line">   <span class="function"><span class="keyword">public</span> PointF <span class="title">evaluate</span><span class="params">(<span class="keyword">float</span> fraction, PointF startValue, PointF endValue)</span> </span>&#123;</span><br><span class="line">       <span class="keyword">float</span> x = startValue.x + (fraction * (endValue.x - startValue.x));</span><br><span class="line">       <span class="keyword">float</span> y = startValue.y + (fraction * (endValue.y - startValue.y));</span><br><span class="line"></span><br><span class="line">       newPoint.set(x, y);</span><br><span class="line"></span><br><span class="line">       <span class="keyword">return</span> newPoint;</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">ObjectAnimator animator = ObjectAnimator.ofObject(view, <span class="string">"position"</span>,  </span><br><span class="line">        <span class="keyword">new</span> PointFEvaluator(), <span class="keyword">new</span> PointF(<span class="number">0</span>, <span class="number">0</span>), <span class="keyword">new</span> PointF(<span class="number">1</span>, <span class="number">1</span>));</span><br><span class="line">animator.start();</span><br></pre></td></tr></table></figure>
<h2 id="3-3-属性动画的监听器"><a href="#3-3-属性动画的监听器" class="headerlink" title="3.3 属性动画的监听器"></a>3.3 属性动画的监听器</h2><p>属性动画提供了监听器用于监听动画的播放过程，主要有如下两个接口：AnimatorUpdateListener和AnimatorListener。</p>
<p>AnimatorListener的定义如下:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="class"><span class="keyword">interface</span> <span class="title">AnimatorListener</span></span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">onAnimationStart</span><span class="params">(Animator animation)</span></span>;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">onAnimationEnd</span><span class="params">(Animator animation)</span></span>;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">onAnimationCancel</span><span class="params">(Animator animation)</span></span>;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">onAnimationRepeat</span><span class="params">(Animator animation)</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>从AnimatorListener的定义可以看出，它可以监听动画的开始、结束、取消以及重复播放。同时为了方便开发，系统还提供了AnimatorListenerAdapter这个类，它是AnimatorListener的适配器类，这样我们就可以有选择地实现上面的4个方法了。</p>
<p>下面再看下AnimatorUpdateListener的定义，如下</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="class"><span class="keyword">interface</span> <span class="title">AnimatorUpdateListener</span></span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">onAnimationUpdate</span><span class="params">(ValueAnimator animation)</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>AnimatorUpdateListener比较特殊，它会监听整个动画过程，动画是由许多帧组成的，每播放一帧，onAnimationUpdate就会被调用一次，利用这个特性，可以做一些特殊的事情。</p>
<h2 id="3-4-对任意属性做动画"><a href="#3-4-对任意属性做动画" class="headerlink" title="3.4 对任意属性做动画"></a>3.4 对任意属性做动画</h2><p>如果给一个Button加一个动画，让这个Button的宽度从当前宽度增加到500px,会发现View动画根本不支持对宽度进行动画，View动画只支持四种类型：平移(Translate)、旋转(Rotate)、缩放(Scale)、透明度(Alpha)。我们可以使用属性动画来实现，如下所示:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">performAnimate</span><span class="params">()</span></span>&#123;</span><br><span class="line">    ObjectAnimator.ofInt(mButton,<span class="string">"width"</span>,<span class="number">500</span>).setDuration(<span class="number">5000</span>).start();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onClick</span><span class="params">(View v)</span></span>&#123;</span><br><span class="line">    <span class="keyword">if</span>(v == mButton)&#123;</span><br><span class="line">        performAnimate();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>上述代码运行后发现没效果，其实没效果是对的，如果随便传递一个属性过去，轻则没动画效果，重则程序直接Crash。</p>
<p>下面分析属性动画的原理:属性动画要求动画作用的对象提供该属性的get和set方法，属性动画根据外界传递的属性的初始值和最终值，以动画的效果多次去调用set方法，每次传递给set方法的值都不一样，确切来说是随着时间的推移，所传递的值越来越接近最终值。总结一下，我们对object的属性abc做动画，如果想让动画生效，要同时满足两个条件：</p>
<p>(1) object必须要提供setAbc方法，如果动画的时候没有传递初始值，那么还要提供getAbc方法，因为系统要去取abc属性的初始值(如果这条不满足，程序直接Crash)。</p>
<p>(2) object的setAbc对属性abc所做的改变必须能够通过某种方法反应出来，比如会带来UI的改变之类的(如果这条不满足，动画无效果但不会Crash)。</p>
<p>以上条件缺一不可。那么为什么我们对Button的width属性做动画会没有效果？这是因为Button内部虽然提供了getWidth和setWidth方法，但是这个setWidth方法并不是改变视图的大小，它是TextView新添加的方法，View是没有这个setWidth方法的，由于Button继承了TextView，所以Button也就有了setWidth方法。下面看下getWidth和setWidth方法的源码：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setWidth</span><span class="params">(<span class="keyword">int</span> pixels)</span></span>&#123;</span><br><span class="line">    mMaxWidth = mMinWidth = pixels;</span><br><span class="line">    mMaxWidthMode = mMinWidthMode = PIXELS;</span><br><span class="line"></span><br><span class="line">    requestLayout();</span><br><span class="line">    invalidate();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">int</span> <span class="title">getWidth</span><span class="params">()</span></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> mRight - mLeft;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>从上述源码可以看出，getWidth的确是获取View的宽度的，而setWidth是TextView和其子类的专属方法，它的作用不是设置View的宽度，而是设置TextView的最大宽度和最小宽度的，这个和TextView的宽度不是一个东西，具体来说，TextView的宽度对应XML中的android:layout_width属性，而TextView还有一个属性android:width,这个android:width属性就对应了TextView的setWidth方法。总之，TextView和Button的setWidth、getWidth干的不是同一件事情，通过setWidth无法改变控件的宽度，所以对width做属性动画没有效果。对应于属性动画的两个条件来说，本例中动画不生效的原因是只满足了条件1而未满足条件2。</p>
<p>针对上述问题，官方文档上告诉我们有3种解决方法：</p>
<ul>
<li><p>给你的对象加上get和set方法，如果你有权限的话；</p>
</li>
<li><p>用一个类来包装原始对象，间接为其提供get和set方法；</p>
</li>
<li><p>采用ValueAnimator，监听动画过程，自己实现属性的改变。</p>
</li>
</ul>
<p>针对上面提供的三种解决方法，下面给出具体介绍。</p>
<p><strong>1. 给你的对象加上get和set方法，如果你有权限的话</strong></p>
<p>这个的意思很好理解，如果你有权限的话，加上get和set就搞定了，但是很多时候我们没权限去这么做，比如本例中无法给Button加一个setWidth方法，这是Android SDK内部实现的。</p>
<p><strong>2. 用一个类来包装原始对象，间接为其提供get和set方法</strong></p>
<p>下面看一个具体的例子：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">performAnimate</span><span class="params">()</span></span>&#123;</span><br><span class="line">    ViewWrapper wrapper = <span class="keyword">new</span> ViewWrapper(mButton);</span><br><span class="line">    ObjectAnimator.ofInt(wrapper,<span class="string">"width"</span>,<span class="number">500</span>).setDuration(<span class="number">5000</span>).start();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onClick</span><span class="params">(View v)</span></span>&#123;</span><br><span class="line">    <span class="keyword">if</span>(v == mButton)&#123;</span><br><span class="line">        performAnimate();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">ViewWrapper</span></span>&#123;</span><br><span class="line">    <span class="keyword">private</span> View mTarget;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">ViewWrapper</span><span class="params">(View target)</span></span>&#123;</span><br><span class="line">        mTarget = target;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getWidth</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">return</span> mTarget.getLayoutParams().width;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setWidth</span><span class="params">(<span class="keyword">int</span> width)</span></span>&#123;</span><br><span class="line">        mTarget.getLayoutParams().width = width;</span><br><span class="line">        mTarget.requestLayout();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>上述代码在5s内让Button的宽度增加到了500px，为了达到这个效果，我们提供了ViewWrapper类专门用于包装View,具体到本例是包装Button。然后我们对ViewWrapper的width属性做动画，并且在setWidth方法中修改其内部的target的宽度，而target实际上就是我们包装的Button。这样一个间接属性动画就完成了，上述代码同样适用于一个对象的其它属性。</p>
<p><strong>3. 采用ValueAnimator,监听动画过程，自己实现属性的改变</strong></p>
<p>首先说说什么是ValueAnimator,ValueAnimator本身不作用于任何对象，也就是说直接使用它没有任何动画效果。它可以对一个值做动画，然后我们可以监听其动画过程，在动画过程中修改我们的对象的属性值，这样也就相当于我们的对象做了动画。如下代码:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">performAnimate</span><span class="params">(<span class="keyword">final</span> View target,<span class="keyword">final</span> <span class="keyword">int</span> start, <span class="keyword">final</span> <span class="keyword">int</span> end)</span></span>&#123;</span><br><span class="line">    ValueAnimator valueAnimator = ValueAnimator.ofInt(<span class="number">1</span>,<span class="number">100</span>);</span><br><span class="line">    valueAnimator.addUpdateListener(<span class="keyword">new</span> AnimatorUpdateListener()&#123;</span><br><span class="line">        <span class="comment">//持有一个IntEvaluator对象，方便下面估值的时候使用</span></span><br><span class="line">        <span class="keyword">private</span> IntEvaluator mEvaluator = <span class="keyword">new</span> IntEvaluator();</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onAnimationUpdate</span><span class="params">(ValueAnimator animator)</span></span>&#123;</span><br><span class="line">            <span class="comment">//获取当前动画的进度值，整型，1~100之间</span></span><br><span class="line">            <span class="keyword">int</span> currentValue = (Integer) animator.getAnimateValue();</span><br><span class="line">            Log.d(TAG,<span class="string">"current value :"</span> + currentValue);</span><br><span class="line"></span><br><span class="line">            <span class="comment">//获取当前进度占整个动画过程的比例，浮点型，0~1之间</span></span><br><span class="line">            <span class="keyword">float</span> fraction = animator.getAnimatedFraction();</span><br><span class="line">            <span class="comment">//直接调用整型估值器，通过比例计算出宽度，然后再设给Button</span></span><br><span class="line">            target.getLayoutParams().width = mEvaluator.evaluate(fraction,start,end);</span><br><span class="line">            target.requestLayout();</span><br><span class="line">        &#125;</span><br><span class="line">        &#125;);</span><br><span class="line"></span><br><span class="line">        valueAnimator.setDuration(<span class="number">5000</span>).start();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onClick</span><span class="params">(View v)</span></span>&#123;</span><br><span class="line">    <span class="keyword">if</span>(v == mButton)&#123;</span><br><span class="line">        performAnimate(mButton,mButton.getWidth(),<span class="number">500</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>上述代码的效果和采用ViewWrapper是一样的，关于ValueAnimator，它会在5000ms内将一根数从1变成100，然后动画的每一帧会回调onAnimationUpdate方法。在这个方法里，我们可以获取当前的值(1~100)和当前值所占用的比例，我们可以计算出Button现在的宽度应该是多少。比如时间过了一半，当前值是50，比例为0.5，假设Button的起始宽度是100px，最终宽度是500px，那么Button增加的宽度也应该占总增加宽度的一半，总增加宽度是500-100=400，所以这个时候Button应该增加的宽度是400x0.5=200，那么当前Button的宽度应该为初始宽度+增加宽度(100+200=300)。</p>
<h2 id="3-5-使用动画的注意事项"><a href="#3-5-使用动画的注意事项" class="headerlink" title="3.5 使用动画的注意事项"></a>3.5 使用动画的注意事项</h2><p><strong>1. OOM问题</strong></p>
<p>这个问题主要出现在帧动画中，当图片数量较多且图片较大时就极易出现OOM，这个在实际开发中尤其注意，尽量避免使用帧动画。</p>
<p><strong>2. 内存泄漏</strong></p>
<p>在属性动画中有一类无限循环的动画，比如：animator.setRepeatCount(ValueAnimator.INFINITE);这类动画需要在Activity退出时及时停止，否则将导致Activity无法释放从而造成内存泄漏，View动画并不存在此问题，因为在view的onDetachedFromWindow方法会取消掉动画，所以不会导致内存泄露。</p>
<p><strong>3. 兼容性问题</strong></p>
<p>动画在3.0以下的系统上有兼容性问题，在某些特殊场景可能无法正常工作，因此要做好适配工作。</p>
<p><strong>4. View动画的问题</strong></p>
<p>View动画是对View的影像做动画，并不是真正的改变View的状态，因此有时候回出现动画完成后Viwe无法隐藏的现象，即setVisibility(View.GONE)失效了，这个时候只要调用view.clearAnimation()清除View动画即可解决此问题。</p>
<p><strong>5. 不要使用px</strong></p>
<p>在进行动画的过程中，要尽量使用dp,使用px会导致在不同的设备上有不同效果。</p>
<p><strong>6. 动画元素的交互</strong></p>
<p>将view移动后，在Android 3.0以前的系统上，不管View动画还是属性动画，新位置均无法触发单击事件，同时，老位置仍然可以触发单击事件，尽管View已经在视觉上不存在了，将View移回原位置以后，原位置的单击事件继续生效。从3.0开始，属性动画的单击事件触发位置为移动后的位置，但是View动画仍然在原位置。</p>
<p><strong>7. 硬件加速</strong></p>
<p>使用动画的过程中，建议开启硬件加速，这样会提高动画的流畅性，但是这种方式不适用于基于自定义属性绘制的动画。</p>

      
    </div>
    
    
    

    
    
      <div>
        <div>
    
        <div style="text-align:center;color: #ccc;font-size:14px;">-------------<i class="fafa-paw">本文结束谢谢阅读</i>-------------</div>
    
</div>
      </div>
    
    

    

    

    

    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/android/" rel="tag"># android</a>
          
        </div>
      

      
      
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2018/04/27/eclipse-dex65536/" rel="next" title="Eclipse dex 65536 问题解决方案">
                <i class="fa fa-chevron-left"></i> Eclipse dex 65536 问题解决方案
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/2018/05/11/android-multithread/" rel="prev" title="Android线程和线程池">
                Android线程和线程池 <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </div>
  
  
  
  </article>



    <div class="post-spread">
      
    </div>
  </div>


          </div>
          


          
  <div class="comments" id="comments">
    
      <div id="gitalk-container"></div>
    
  </div>


        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap" >
            文章目录
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview">
            站点概览
          </li>
        </ul>
      

      <section class="site-overview sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
          <img class="site-author-image" itemprop="image"
               src="/images/avatar.gif"
               alt="曲连强" />
          <p class="site-author-name" itemprop="name">曲连强</p>
           
              <p class="site-description motion-element" itemprop="description">Hello World</p>
          
        </div>
        <nav class="site-state motion-element">

          
            <div class="site-state-item site-state-posts">
              <a href="/archives/">
                <span class="site-state-item-count">4</span>
                <span class="site-state-item-name">日志</span>
              </a>
            </div>
          

          
            
            
            <div class="site-state-item site-state-categories">
              <a href="/categories/index.html">
                <span class="site-state-item-count">1</span>
                <span class="site-state-item-name">分类</span>
              </a>
            </div>
          

          
            
            
            <div class="site-state-item site-state-tags">
              <a href="/tags/index.html">
                <span class="site-state-item-count">1</span>
                <span class="site-state-item-name">标签</span>
              </a>
            </div>
          

        </nav>

        

        <div class="links-of-author motion-element">
          
        </div>

        
        

        
        

        


      </section>

      
      <!--noindex-->
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
              
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#一、-View动画"><span class="nav-number">1.</span> <span class="nav-text">一、 View动画</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#1-1-View动画的种类"><span class="nav-number">1.0.1.</span> <span class="nav-text">1.1 View动画的种类</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#1-2-自定义View动画"><span class="nav-number">1.0.2.</span> <span class="nav-text">1.2 自定义View动画</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#1-3-帧动画"><span class="nav-number">1.0.3.</span> <span class="nav-text">1.3 帧动画</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#二、-View动画的特殊使用场景"><span class="nav-number">2.</span> <span class="nav-text">二、 View动画的特殊使用场景</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#2-1-LayoutAnimation"><span class="nav-number">2.1.</span> <span class="nav-text">2.1 LayoutAnimation</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-2-Activity-的切换效果"><span class="nav-number">2.2.</span> <span class="nav-text">2.2 Activity 的切换效果</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#三、-属性动画"><span class="nav-number">3.</span> <span class="nav-text">三、 属性动画</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#3-1-使用属性动画"><span class="nav-number">3.1.</span> <span class="nav-text">3.1 使用属性动画</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-2-理解插值器和估值器"><span class="nav-number">3.2.</span> <span class="nav-text">3.2 理解插值器和估值器</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#3-3-属性动画的监听器"><span class="nav-number">4.</span> <span class="nav-text">3.3 属性动画的监听器</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#3-4-对任意属性做动画"><span class="nav-number">5.</span> <span class="nav-text">3.4 对任意属性做动画</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#3-5-使用动画的注意事项"><span class="nav-number">6.</span> <span class="nav-text">3.5 使用动画的注意事项</span></a></li></ol></div>
            

          </div>
        </section>
      <!--/noindex-->
      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright" >
  
  &copy; 
  <span itemprop="copyrightYear">2018</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">曲连强</span>
</div>



        

        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>

  
  <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>

  
  <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.2"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.2"></script>



  
  

  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.2"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.1.2"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.2"></script>



  


  




	





  





  






  <link rel="stylesheet" href="https://unpkg.com/gitalk/dist/gitalk.css">
  <script src="https://unpkg.com/gitalk/dist/gitalk.min.js"></script>
   <script type="text/javascript">
        var gitalk = new Gitalk({
          clientID: '3a898860499006d001be',
          clientSecret: '0e4e22e3c3c85a8ed88c49ba1b0430daf3aa5d0a',
          repo: 'lianqiangjava.github.io',
          owner: 'lianqiangjava',
          admin: ['lianqiangjava'],
          id: location.pathname,
          distractionFreeMode: 'true'
        })
        gitalk.render('gitalk-container')           
       </script>


  





  

  
  <script src="https://cdn1.lncld.net/static/js/av-core-mini-0.6.4.js"></script>
  <script>AV.initialize("ihUQ8fwiQ28rS8MMrufrxb30-gzGzoHsz", "BDCcWz1MDOBjdnwYKoNQqjzE");</script>
  <script>
    function showTime(Counter) {
      var query = new AV.Query(Counter);
      var entries = [];
      var $visitors = $(".leancloud_visitors");

      $visitors.each(function () {
        entries.push( $(this).attr("id").trim() );
      });

      query.containedIn('url', entries);
      query.find()
        .done(function (results) {
          var COUNT_CONTAINER_REF = '.leancloud-visitors-count';

          if (results.length === 0) {
            $visitors.find(COUNT_CONTAINER_REF).text(0);
            return;
          }

          for (var i = 0; i < results.length; i++) {
            var item = results[i];
            var url = item.get('url');
            var time = item.get('time');
            var element = document.getElementById(url);

            $(element).find(COUNT_CONTAINER_REF).text(time);
          }
          for(var i = 0; i < entries.length; i++) {
            var url = entries[i];
            var element = document.getElementById(url);
            var countSpan = $(element).find(COUNT_CONTAINER_REF);
            if( countSpan.text() == '') {
              countSpan.text(0);
            }
          }
        })
        .fail(function (object, error) {
          console.log("Error: " + error.code + " " + error.message);
        });
    }

    function addCount(Counter) {
      var $visitors = $(".leancloud_visitors");
      var url = $visitors.attr('id').trim();
      var title = $visitors.attr('data-flag-title').trim();
      var query = new AV.Query(Counter);

      query.equalTo("url", url);
      query.find({
        success: function(results) {
          if (results.length > 0) {
            var counter = results[0];
            counter.fetchWhenSave(true);
            counter.increment("time");
            counter.save(null, {
              success: function(counter) {
                var $element = $(document.getElementById(url));
                $element.find('.leancloud-visitors-count').text(counter.get('time'));
              },
              error: function(counter, error) {
                console.log('Failed to save Visitor num, with error message: ' + error.message);
              }
            });
          } else {
            var newcounter = new Counter();
            /* Set ACL */
            var acl = new AV.ACL();
            acl.setPublicReadAccess(true);
            acl.setPublicWriteAccess(true);
            newcounter.setACL(acl);
            /* End Set ACL */
            newcounter.set("title", title);
            newcounter.set("url", url);
            newcounter.set("time", 1);
            newcounter.save(null, {
              success: function(newcounter) {
                var $element = $(document.getElementById(url));
                $element.find('.leancloud-visitors-count').text(newcounter.get('time'));
              },
              error: function(newcounter, error) {
                console.log('Failed to create');
              }
            });
          }
        },
        error: function(error) {
          console.log('Error:' + error.code + " " + error.message);
        }
      });
    }

    $(function() {
      var Counter = AV.Object.extend("Counter");
      if ($('.leancloud_visitors').length == 1) {
        addCount(Counter);
      } else if ($('.post-title-link').length > 1) {
        showTime(Counter);
      }
    });
  </script>



  

  

  

  

  

</body>
</html>
